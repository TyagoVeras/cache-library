import"reflect-metadata";import*as y from"fs";import*as v from"path";function S(o){if(!o.defaultRootKey)throw new Error("Default root key is not defined");if(o.strategy==="redis"&&!o.connectionUrl)throw new Error("Redis connection URL is not defined")}var I=v.resolve(y.realpathSync(process.cwd()),"cache-config.json"),b=y.readFileSync(I,"utf-8"),h=JSON.parse(b);S(h);var r={strategy:h.strategy,connectionUrl:h.connectionUrl,defaultRootKey:h.defaultRootKey,defaultTtl:3600};import P from"node-cache";var g=class{constructor(){this.cache=new P}async get(e){return this.cache.get(e)}async set(e,t,i){this.cache.set(e,t,i/1e3)}};import O from"ioredis";var p=class{constructor(){if(!r.connectionUrl)throw new Error("Redis connection URL is not defined");this.cache=new O(r.connectionUrl)}async get(e){let t=await this.cache.get(e);return t?JSON.parse(t):null}async set(e,t,i){await this.cache.set(e,JSON.stringify(t),"PX",i)}};var f,U={"node-cache":g,redis:p};f=new U[r.strategy];function R(o,e){return`${o}:${JSON.stringify(e)}`}function K({cacheKey:o,ttl:e}){return function(t,i,u){let d=`${r.defaultRootKey}:${o}`,m=e||r.defaultTtl;if(u&&i){let l=u.value;u.value=async function(...n){let a=R(d,n),s=await f.get(a);if(s)return console.log("Returning cached value for",a),s;let c=await l.apply(this,n);return await f.set(a,c,m),console.log("Caching value for",a),c}}else for(let l of Object.getOwnPropertyNames(t.prototype)){let n=Object.getOwnPropertyDescriptor(t.prototype,l);if(n&&n.value instanceof Function){let a=n.value;n.value=async function(...s){let c=R(d,s),C=await f.get(c);if(C)return console.log("Returning cached value for",c),C;let w=await a.apply(this,s);return await f.set(c,w,m),console.log("Caching value for",c),w},Object.defineProperty(t.prototype,l,n)}}}}export{K as cacheInjectable};
